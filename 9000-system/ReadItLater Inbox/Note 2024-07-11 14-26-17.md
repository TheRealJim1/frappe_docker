[[ReadItLater]] [[Textsnippet]]

Certainly! Let's integrate the code I provided earlier with the portal settings we see in the image. We'll modify our approach to align with the existing structure in ERPNext/Frappe. Here's how we can marry the two:

1. Custom DocType for Subscriptions:
We'll keep our CustomerSubscription DocType, but we'll integrate it with the existing User and Customer doctypes.

```python
# In your custom app, create customer_subscription.json
{
 "name": "Customer Subscription",
 "doctype": "DocType",
 "fields": [
  {
   "fieldname": "user",
   "fieldtype": "Link",
   "label": "User",
   "options": "User",
   "reqd": 1
  },
  {
   "fieldname": "customer",
   "fieldtype": "Link",
   "label": "Customer",
   "options": "Customer",
   "reqd": 1
  },
  {
   "fieldname": "subscription_level",
   "fieldtype": "Select",
   "label": "Subscription Level",
   "options": "Free\nPremium\nEnterprise",
   "reqd": 1
  },
  {
   "fieldname": "expiry_date",
   "fieldtype": "Date",
   "label": "Expiry Date"
  }
 ]
}

```

2. Modify Portal Settings:
We'll add our custom pages to the Portal Menu.

```python
# In your custom app's hooks.py

portal_menu_items = [
    {"title": "Dashboard", "route": "/customer-dashboard", "reference_doctype": "Customer Subscription", "role": "Customer"},
    {"title": "Subscription", "route": "/customer-subscription", "reference_doctype": "Customer Subscription", "role": "Customer"},
    # Keep existing menu items like Projects, Quotations, Orders, Invoices
]

# Add this to your hooks.py
override_doctype_dashboards = {
    "Customer": "your_custom_app.your_custom_app.dashboard.get_customer_dashboard"
}

```

3. Create Custom Web Pages:
We'll create custom web pages for the dashboard and subscription management.

```html
# File: your_custom_app/www/customer-dashboard.html
{% extends "templates/web.html" %}
{% block page_content %}
<h1>Welcome, {{ frappe.get_doc("Customer", frappe.session.user).customer_name }}</h1>
<p>Your current subscription: {{ subscription.subscription_level }}</p>
<!-- Add more dashboard content here -->
{% endblock %}

# File: your_custom_app/www/customer-subscription.html
{% extends "templates/web.html" %}
{% block page_content %}
<h1>Your Subscription</h1>
<p>Current plan: {{ subscription.subscription_level }}</p>
<p>Expires on: {{ subscription.expiry_date }}</p>
<a href="/upgrade-subscription" class="btn btn-primary">Upgrade Subscription</a>
{% endblock %}

# File: your_custom_app/www/customer-dashboard.py
import frappe

def get_context(context):
    if frappe.session.user == 'Guest':
        frappe.local.flags.redirect_location = '/login'
        raise frappe.Redirect
    
    context.subscription = frappe.get_doc('Customer Subscription', {'user': frappe.session.user})

# Similar Python files for other custom pages

```

4. Integrate with User Signup:
Modify the user signup process to create a Customer and CustomerSubscription.

```python
# In your custom app, create a new file like custom_signup.py

import frappe

def after_signup(user, kwargs):
    # Create Customer
    customer = frappe.get_doc({
        "doctype": "Customer",
        "customer_name": user.full_name,
        "customer_type": "Individual",
        "customer_group": "Individual",
        "territory": "All Territories",
        "email_id": user.email
    })
    customer.insert(ignore_permissions=True)

    # Create Customer Subscription
    subscription = frappe.get_doc({
        "doctype": "Customer Subscription",
        "user": user.name,
        "customer": customer.name,
        "subscription_level": "Free"
    })
    subscription.insert(ignore_permissions=True)

# In your hooks.py, add:
doc_events = {
    "User": {
        "after_insert": "your_custom_app.custom_signup.after_signup"
    }
}

```

5. Implement Subscription Logic:
Add logic to handle subscription upgrades and access control.

```python
# In your custom app, create subscription_utils.py

import frappe

def upgrade_subscription(user, new_level):
    subscription = frappe.get_doc("Customer Subscription", {"user": user})
    subscription.subscription_level = new_level
    subscription.save()
    
    # Here you would typically integrate with a payment gateway
    # and only update the subscription after successful payment

def check_subscription_access(user, feature):
    subscription = frappe.get_doc("Customer Subscription", {"user": user})
    access_levels = {
        "Free": ["basic_feature"],
        "Premium": ["basic_feature", "advanced_feature"],
        "Enterprise": ["basic_feature", "advanced_feature", "enterprise_feature"]
    }
    return feature in access_levels.get(subscription.subscription_level, [])

# Use this in your route permissions or in your custom pages to control access

```

To implement this:

1. Create the CustomerSubscription DocType in your Frappe/ERPNext system.
2. Modify your hooks.py to include the portal_menu_items and doc_events.
3. Create the custom web pages (HTML and Python files) in your custom app's www directory.
4. Implement the custom signup logic to create Customer and CustomerSubscription records.
5. Add the subscription logic to handle upgrades and access control.
6. Modify existing ERPNext pages (like Projects, Quotations, etc.) to use the check_subscription_access function if you want to restrict certain features based on subscription level.

This approach integrates your custom portal functionality with the existing ERPNext portal structure, allowing you to leverage built-in features while adding your subscription-based access control.

Remember to thoroughly test each component, especially the integration points between your custom code and the existing ERPNext functionality. You may need to adjust permissions and roles to ensure everything works smoothly.

Would you like me to elaborate on any specific part of this integration?